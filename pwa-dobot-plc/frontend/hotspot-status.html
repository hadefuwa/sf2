<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="/assets/img/favicon.png">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>Wi‑Fi Hotspot Status - Smart Factory</title>
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no" name="viewport" />

  <!-- Fonts and icons - all local (no internet required for HMI) -->
  <link rel="stylesheet" href="/assets/fontawesome/css/all.min.css">

  <!-- CSS Files -->
  <link href="/assets/css/material-dashboard.min.css?v=2.1.0" rel="stylesheet" />
  <link href="/assets/css/professional-theme.css" rel="stylesheet" />

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#030c1d">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>

<body class="dark-edition">
  <div class="wrapper">
    <div class="sidebar" data-color="purple" data-background-color="black" data-image="">
      <div class="sidebar-animated-bg" id="sidebarAnimatedBg"></div>
      <div class="logo">
        <a href="/" class="simple-text logo-normal">
          <i class="material-icons">factory</i>
          Smart Factory
        </a>
      </div>
      <div class="sidebar-wrapper">
        <ul class="nav">
          <li class="nav-item">
            <a class="nav-link" href="/index.html">
              <i class="material-icons">dashboard</i>
              <p>Dashboard</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/robot-arm.html">
              <i class="material-icons">precision_manufacturing</i>
              <p>Robot Arm</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/vision-system.html">
              <i class="material-icons">visibility</i>
              <p>Vision System</p>
            </a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="/rfid.html">
              <i class="material-icons">nfc</i>
              <p>RFID Tracking</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/digital-twin.html">
              <i class="material-icons">view_in_ar</i>
              <p>Digital Twin</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/plc-diagnostics.html">
              <i class="material-icons">analytics</i>
              <p>PLC Diagnostics</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/io-link.html">
              <i class="material-icons">settings_input_component</i>
              <p>IO-Link Master</p>
            </a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="/hotspot-status.html">
              <i class="material-icons">wifi</i>
              <p>Wi‑Fi Hotspot</p>
            </a>
          </li>
        </ul>
      </div>
    </div>

    <div class="main-panel">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-transparent navbar-absolute fixed-top">
        <div class="container-fluid">
          <div class="navbar-wrapper">
            <a class="navbar-brand" href="javascript:;">Wi‑Fi Hotspot Status</a>
          </div>
        </div>
      </nav>
      <!-- End Navbar -->

      <div class="content">
        <div class="container-fluid">
          <div class="row">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header card-header-purple">
                  <h4 class="card-title">Raspberry Pi Wi‑Fi Hotspot</h4>
                  <p class="card-category">
                    Simple check that your Pi access point is running so phones can connect.
                  </p>
                </div>
                <div class="card-body">
                  <div id="statusSummary" class="alert alert-info">
                    Checking hotspot status...
                  </div>

                  <div class="row">
                    <div class="col-md-6">
                      <h5>Service Status</h5>
                      <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                          hostapd (Wi‑Fi Access Point)
                          <span id="hostapdStatus" class="badge badge-secondary badge-pill">-</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                          dnsmasq (DHCP Server)
                          <span id="dnsmasqStatus" class="badge badge-secondary badge-pill">-</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                          wlan0 IP (should be 192.168.4.1)
                          <span id="wlanStatus" class="badge badge-secondary badge-pill">-</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                          Connected Devices (DHCP leases)
                          <span id="leasesCount" class="badge badge-secondary badge-pill">-</span>
                        </li>
                      </ul>
                    </div>
                    <div class="col-md-6">
                      <h5>How to Use</h5>
                      <ol>
                        <li>Make sure you already ran <code>scripts/setup_wifi_access_point.sh</code> on the Pi.</li>
                        <li>Check that all three items above are green.</li>
                        <li>On your phone, connect to Wi‑Fi network <strong>SmartFactory</strong> with password <strong>matrix123</strong>.</li>
                        <li>Open a browser and go to <code>http://192.168.4.1:8080</code>.</li>
                      </ol>
                      <button class="btn btn-primary" id="refreshButton">Refresh Status</button>
                    </div>
                  </div>

                  <div id="errorBox" class="alert alert-danger" style="display:none; margin-top:20px;">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!--   Core JS Files   -->
  <script src="/assets/js/core/jquery.min.js"></script>
  <script src="/assets/js/core/popper.min.js"></script>
  <script src="/assets/js/core/bootstrap-material-design.min.js"></script>
  <script src="/assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>
  <script src="/assets/js/material-dashboard.min.js?v=2.1.0"></script>
  <script src="/assets/js/material-dashboard.js"></script>

  <script>
    function setBadge(elementId, isOk, textIfOk, textIfNotOk) {
      var el = document.getElementById(elementId);
      if (!el) return;

      el.textContent = isOk ? textIfOk : textIfNotOk;
      el.classList.remove('badge-secondary', 'badge-success', 'badge-danger');
      el.classList.add(isOk ? 'badge-success' : 'badge-danger');
    }

    function updateHotspotStatus() {
      var statusSummary = document.getElementById('statusSummary');
      var errorBox = document.getElementById('errorBox');

      statusSummary.className = 'alert alert-info';
      statusSummary.textContent = 'Checking hotspot status...';
      errorBox.style.display = 'none';
      errorBox.textContent = '';

      fetch('/api/hotspot/status')
        .then(function (response) {
          if (!response.ok) {
            throw new Error('HTTP ' + response.status);
          }
          return response.json();
        })
        .then(function (data) {
          setBadge('hostapdStatus', data.hostapd_active, 'Active', 'Not Active');
          setBadge('dnsmasqStatus', data.dnsmasq_active, 'Active', 'Not Active');
          setBadge('wlanStatus', data.wlan0_has_ap_ip, '192.168.4.1 OK', 'Missing / Different IP');

          var leasesEl = document.getElementById('leasesCount');
          if (leasesEl) {
            leasesEl.textContent = typeof data.leases_count === 'number' ? data.leases_count : '-';
            leasesEl.classList.remove('badge-secondary');
            leasesEl.classList.add('badge-info');
          }

          if (data.ok) {
            statusSummary.className = 'alert alert-success';
            statusSummary.textContent = '✅ Hotspot looks good. Phones should be able to connect to Wi‑Fi and reach http://192.168.4.1:8080.';
          } else {
            statusSummary.className = 'alert alert-warning';
            statusSummary.textContent = '⚠️ Hotspot is not fully healthy yet. Check the red items above.';
          }
        })
        .catch(function (err) {
          statusSummary.className = 'alert alert-danger';
          statusSummary.textContent = 'Error checking hotspot status.';
          errorBox.style.display = 'block';
          errorBox.textContent = 'Details: ' + err.message + '. Is the backend running on the Raspberry Pi?';
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
      var btn = document.getElementById('refreshButton');
      if (btn) {
        btn.addEventListener('click', function () {
          updateHotspotStatus();
        });
      }
      updateHotspotStatus();
    });
  </script>
</body>
</html>

