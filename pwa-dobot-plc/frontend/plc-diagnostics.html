<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <link rel="apple-touch-icon" sizes="76x76" href="./assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="./assets/img/favicon.png">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>PLC Tag Diagnostics - Smart Factory</title>
  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
  
  <!-- Fonts and icons -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
  
  <!-- CSS Files -->
  <link href="./assets/css/material-dashboard.min.css?v=2.1.0" rel="stylesheet" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1c1b1f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    .card:hover {
      transform: translateY(-5px);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .status-panel {
      margin-bottom: 24px;
    }

    .status-row {
      display: grid;
      grid-template-columns: 220px 1fr;
      padding: 16px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      align-items: center;
    }

    .status-row:last-child {
      border-bottom: none;
    }

    .status-label {
      color: rgba(255, 255, 255, 0.7);
      font-weight: 600;
      font-size: 14px;
    }

    .status-value {
      font-size: 18px;
      font-weight: 600;
      font-family: 'Courier New', monospace;
    }

    .status-value.active {
      color: #4caf50;
      font-weight: bold;
      text-shadow: 0 0 8px rgba(76, 175, 80, 0.4);
    }

    .status-value.inactive {
      color: #f44336;
      text-shadow: 0 0 8px rgba(244, 67, 54, 0.4);
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin: 24px 0;
      flex-wrap: wrap;
    }

    .btn-control {
      background: rgba(156, 39, 176, 0.2);
      border: 1px solid #9c27b0;
      color: white;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    .btn-control:hover {
      background: rgba(156, 39, 176, 0.4);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-box {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
    }

    .stat-label {
      color: rgba(255, 255, 255, 0.6);
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .stat-value {
      color: #a8c7fa;
      font-size: 28px;
      font-weight: 700;
      font-family: 'Courier New', monospace;
    }

    .log-panel {
      background: #0f0e11;
      border: 1px solid #44464f;
      border-radius: 8px;
      padding: 20px;
      height: 450px;
      overflow-y: auto;
      font-size: 13px;
      font-family: 'Courier New', monospace;
    }

    .log-entry {
      margin-bottom: 6px;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .log-timestamp {
      color: #8f9099;
      margin-right: 8px;
    }

    .log-true {
      color: #4caf50;
      font-weight: bold;
      text-shadow: 0 0 8px rgba(76, 175, 80, 0.4);
    }

    .log-false {
      color: #f44336;
      font-weight: bold;
      text-shadow: 0 0 8px rgba(244, 67, 54, 0.4);
    }

    /* Bold White Text Override */
    body, .card-body, .card-title, .card-category, p, span, div, td, th, label {
      color: #ffffff !important;
      font-weight: 500 !important;
    }

    .card-header .card-title,
    .card-header .card-category {
      color: #ffffff !important;
      font-weight: 600 !important;
    }

    h1, h2, h3, h4, h5, h6 {
      color: #ffffff !important;
      font-weight: 700 !important;
    }

    .sidebar .nav li a p {
      color: rgba(255, 255, 255, 0.95) !important;
      font-weight: 500 !important;
    }
  </style>
</head>

<body class="dark-edition">
  <div class="wrapper">
    <div class="sidebar" data-color="purple" data-background-color="black" data-image="./assets/img/sidebar-2.jpg">
      <div class="logo">
        <a href="/" class="simple-text logo-normal">
          <i class="material-icons">factory</i>
          Smart Factory
        </a>
      </div>
      <div class="sidebar-wrapper">
        <ul class="nav">
          <li class="nav-item">
            <a class="nav-link" href="/index.html">
              <i class="material-icons">dashboard</i>
              <p>Dashboard</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/robot-arm.html">
              <i class="material-icons">precision_manufacturing</i>
              <p>Robot Arm</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/vision-system.html">
              <i class="material-icons">visibility</i>
              <p>Vision System</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/smart-factory.html">
              <i class="material-icons">settings</i>
              <p>Factory Control</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/rfid.html">
              <i class="material-icons">nfc</i>
              <p>RFID Tracking</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/digital-twin.html">
              <i class="material-icons">view_in_ar</i>
              <p>Digital Twin</p>
            </a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="/plc-diagnostics.html">
              <i class="material-icons">analytics</i>
              <p>PLC Diagnostics</p>
            </a>
          </li>
        </ul>
      </div>
    </div>

    <div class="main-panel">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-transparent navbar-absolute fixed-top">
        <div class="container-fluid">
          <div class="navbar-wrapper">
            <a class="navbar-brand" href="javascript:;">PLC Diagnostics</a>
          </div>
          <button class="navbar-toggler" type="button" data-toggle="collapse" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="navbar-toggler-icon icon-bar"></span>
            <span class="navbar-toggler-icon icon-bar"></span>
            <span class="navbar-toggler-icon icon-bar"></span>
          </button>
        </div>
      </nav>
      <!-- End Navbar -->

      <div class="content">
        <div class="container-fluid">
          <div class="row">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header card-header-primary">
                  <h4 class="card-title">PLC Tag Diagnostics - S7-1200</h4>
                  <p class="card-category">Real-time monitoring of Siemens PLC data blocks - DB123.DBX40.0 Start Bit</p>
                </div>
                <div class="card-body">
                  <!-- Status Panel -->
                  <div class="status-panel">
                    <div class="status-row">
                      <div class="status-label">PLC Connected:</div>
                      <div class="status-value" id="plcConnected">-</div>
                    </div>
                    <div class="status-row">
                      <div class="status-label">DB123.DBX40.0:</div>
                      <div class="status-value" id="startBitValue">-</div>
                    </div>
                    <div class="status-row">
                      <div class="status-label">Last Update:</div>
                      <div class="status-value" id="lastUpdate">-</div>
                    </div>
                    <div class="status-row">
                      <div class="status-label">Poll Interval:</div>
                      <div class="status-value" id="pollInterval">500ms</div>
                    </div>
                  </div>

                  <!-- Controls -->
                  <div class="controls">
                    <button class="btn-control" onclick="setPollInterval(250)">250ms</button>
                    <button class="btn-control" onclick="setPollInterval(500)">500ms</button>
                    <button class="btn-control" onclick="setPollInterval(1000)">1000ms</button>
                    <button class="btn-control" onclick="setPollInterval(2000)">2000ms</button>
                    <button class="btn-control" onclick="clearLog()">Clear Log</button>
                    <button class="btn-control" onclick="togglePause()">Pause/Resume</button>
                  </div>

                  <!-- Stats Grid -->
                  <div class="stats-grid">
                    <div class="stat-box">
                      <div class="stat-label">Total Reads</div>
                      <div class="stat-value" id="totalReads">0</div>
                    </div>
                    <div class="stat-box">
                      <div class="stat-label">TRUE Count</div>
                      <div class="stat-value" id="trueCount">0</div>
                    </div>
                    <div class="stat-box">
                      <div class="stat-label">FALSE Count</div>
                      <div class="stat-value" id="falseCount">0</div>
                    </div>
                    <div class="stat-box">
                      <div class="stat-label">Errors</div>
                      <div class="stat-value" id="errorCount">0</div>
                    </div>
                    <div class="stat-box">
                      <div class="stat-label">Uptime</div>
                      <div class="stat-value" id="uptime">00:00</div>
                    </div>
                    <div class="stat-box">
                      <div class="stat-label">TRUE %</div>
                      <div class="stat-value" id="truePercent">0%</div>
                    </div>
                  </div>

                  <!-- Log Panel -->
                  <div class="log-panel" id="logPanel">
                    <div class="log-entry">Waiting for data...</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Core JS Files -->
  <script src="./assets/js/core/jquery.min.js"></script>
  <script src="./assets/js/core/popper.min.js"></script>
  <script src="./assets/js/core/bootstrap-material-design.min.js"></script>
  <script src="./assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>
  <script src="./assets/js/material-dashboard.min.js?v=2.1.0" type="text/javascript"></script>

  <script>
    // ========== PLC DIAGNOSTICS LOGIC ==========
    const API_BASE = window.location.origin;
    let pollIntervalMs = 500;
    let pollTimer = null;
    let paused = false;
    let startTime = Date.now();

    let stats = {
      total: 0,
      trueCount: 0,
      falseCount: 0,
      errors: 0
    };

    function addLog(message, isTrue = null) {
      const logPanel = document.getElementById('logPanel');
      const timestamp = new Date().toLocaleTimeString() + '.' + new Date().getMilliseconds().toString().padStart(3, '0');
      const entry = document.createElement('div');
      entry.className = 'log-entry';

      let valueClass = '';
      if (isTrue === true) valueClass = 'log-true';
      else if (isTrue === false) valueClass = 'log-false';

      entry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> <span class="${valueClass}">${message}</span>`;

      logPanel.insertBefore(entry, logPanel.firstChild);

      // Keep only last 100 entries
      while (logPanel.children.length > 100) {
        logPanel.removeChild(logPanel.lastChild);
      }
    }

    function updateStats() {
      document.getElementById('totalReads').textContent = stats.total;
      document.getElementById('trueCount').textContent = stats.trueCount;
      document.getElementById('falseCount').textContent = stats.falseCount;
      document.getElementById('errorCount').textContent = stats.errors;

      const percent = stats.total > 0 ? ((stats.trueCount / stats.total) * 100).toFixed(1) : 0;
      document.getElementById('truePercent').textContent = percent + '%';

      // Update uptime
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      document.getElementById('uptime').textContent =
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    async function pollStartBit() {
      if (paused) return;

      try {
        const response = await fetch(`${API_BASE}/api/plc/db40/start`, {
          signal: AbortSignal.timeout(5000)
        });

        const data = await response.json();

        stats.total++;

        if (data.success) {
          const startValue = data.start;

          if (startValue) {
            stats.trueCount++;
            addLog(`Start bit = TRUE`, true);
          } else {
            stats.falseCount++;
            addLog(`Start bit = FALSE`, false);
          }

          // Update UI
          const valueElement = document.getElementById('startBitValue');
          if (startValue) {
            valueElement.textContent = 'TRUE ⚡';
            valueElement.className = 'status-value active';
          } else {
            valueElement.textContent = 'FALSE ⚫';
            valueElement.className = 'status-value inactive';
          }

          document.getElementById('plcConnected').textContent = data.plc_connected ? 'YES ✓' : 'NO ✗';
          document.getElementById('plcConnected').className = data.plc_connected ? 'status-value active' : 'status-value inactive';

        } else {
          stats.errors++;
          addLog(`ERROR: ${data.error || 'Unknown error'}`);
        }

        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        updateStats();

      } catch (error) {
        stats.errors++;
        addLog(`EXCEPTION: ${error.message}`);
        updateStats();
      }
    }

    function setPollInterval(ms) {
      pollIntervalMs = ms;
      document.getElementById('pollInterval').textContent = ms + 'ms';

      if (pollTimer) {
        clearInterval(pollTimer);
      }

      pollTimer = setInterval(pollStartBit, pollIntervalMs);
      addLog(`Poll interval changed to ${ms}ms`);
    }

    function clearLog() {
      document.getElementById('logPanel').innerHTML = '';
      stats = { total: 0, trueCount: 0, falseCount: 0, errors: 0 };
      startTime = Date.now();
      updateStats();
      addLog('Log cleared');
    }

    function togglePause() {
      paused = !paused;
      addLog(paused ? 'PAUSED' : 'RESUMED');
    }

    // Start polling
    setPollInterval(500);

    // Update uptime every second
    setInterval(() => {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      document.getElementById('uptime').textContent =
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
  </script>
</body>
</html>
