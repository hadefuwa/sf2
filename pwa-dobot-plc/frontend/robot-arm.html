<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <link rel="apple-touch-icon" sizes="76x76" href="./assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="./assets/img/favicon.png">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>Robot Arm Control - Smart Factory</title>
  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
  
  <!-- Fonts and icons -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
  
  <!-- CSS Files -->
  <link href="./assets/css/material-dashboard.min.css?v=2.1.0" rel="stylesheet" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1c1b1f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    .card:hover {
      transform: translateY(-5px);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .status-dot {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      background: #ef4444;
      animation: pulse 2s infinite;
    }

    .status-dot.connected {
      background: #10b981;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    #debugLog {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      background: #0f0e11;
      border: 1px solid #44464f;
      border-radius: 4px;
      padding: 16px;
      color: #4caf50;
    }

    .preset-btn {
      width: 100%;
      margin-bottom: 8px;
    }

    .settings-modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
    }

    .settings-content {
      background-color: #282730;
      margin: 5% auto;
      padding: 30px;
      border: 1px solid #44464f;
      border-radius: 12px;
      width: 80%;
      max-width: 700px;
      max-height: 80vh;
      overflow-y: auto;
      color: #e4e1e6;
    }

    .settings-close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .settings-close:hover {
      color: #fff;
    }
  </style>
</head>

<body class="dark-edition">
  <div class="wrapper ">
    <div class="sidebar" data-color="purple" data-background-color="black" data-image="./assets/img/sidebar-2.jpg">
      <div class="logo">
        <a href="/" class="simple-text logo-normal">
          <i class="material-icons">factory</i>
          Smart Factory
        </a>
      </div>
      <div class="sidebar-wrapper">
        <ul class="nav">
          <li class="nav-item">
            <a class="nav-link" href="/index.html">
              <i class="material-icons">dashboard</i>
              <p>Dashboard</p>
            </a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="/robot-arm.html">
              <i class="material-icons">precision_manufacturing</i>
              <p>Robot Arm</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/vision-system.html">
              <i class="material-icons">visibility</i>
              <p>Vision System</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/smart-factory.html">
              <i class="material-icons">settings</i>
              <p>Factory Control</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/rfid.html">
              <i class="material-icons">nfc</i>
              <p>RFID Tracking</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/digital-twin.html">
              <i class="material-icons">view_in_ar</i>
              <p>Digital Twin</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/plc-diagnostics.html">
              <i class="material-icons">analytics</i>
              <p>PLC Diagnostics</p>
            </a>
          </li>
        </ul>
      </div>
    </div>

    <div class="main-panel">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-transparent navbar-absolute fixed-top ">
        <div class="container-fluid">
          <div class="navbar-wrapper">
            <a class="navbar-brand" href="javascript:;">Robot Arm Control</a>
          </div>
          <button class="navbar-toggler" type="button" data-toggle="collapse" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="navbar-toggler-icon icon-bar"></span>
            <span class="navbar-toggler-icon icon-bar"></span>
            <span class="navbar-toggler-icon icon-bar"></span>
          </button>
          <div class="collapse navbar-collapse justify-content-end">
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link" href="javascript:;">
                  <i class="material-icons">notifications</i>
                  <p class="d-lg-none d-md-block">Notifications</p>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      <!-- End Navbar -->

      <div class="content">
        <div class="container-fluid">
          <!-- Connection Status Cards -->
          <div class="row">
            <div class="col-lg-6 col-md-6 col-sm-12">
              <div class="card card-stats">
                <div class="card-header card-header-success card-header-icon">
                  <div class="card-icon">
                    <i class="material-icons">link</i>
                  </div>
                  <p class="card-category">PLC Connection</p>
                  <h3 class="card-title">
                    <span class="status-dot" id="plcDot"></span>
                    <span id="plcStatus">Checking...</span>
                  </h3>
                </div>
                <div class="card-footer">
                  <div class="stats">
                    <i class="material-icons">update</i>
                    Last updated: <span id="lastUpdate">--:--:--</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-lg-6 col-md-6 col-sm-12">
              <div class="card card-stats">
                <div class="card-header card-header-warning card-header-icon">
                  <div class="card-icon">
                    <i class="material-icons">precision_manufacturing</i>
                  </div>
                  <p class="card-category">Dobot Status</p>
                  <h3 class="card-title">
                    <span class="status-dot" id="dobotDot"></span>
                    <span id="dobotStatus">Checking...</span>
                  </h3>
                </div>
                <div class="card-footer">
                  <div class="stats">
                    <i class="material-icons">info</i>
                    Check connection status
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Robot Position Cards -->
          <div class="row">
            <div class="col-lg-6 col-md-12">
              <div class="card">
                <div class="card-header card-header-info">
                  <h4 class="card-title">Target Position (PLC)</h4>
                  <p class="card-category">Position from PLC DB</p>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-4">
                      <h5 class="card-category">X</h5>
                      <h2 class="card-title" id="targetX">--</h2>
                    </div>
                    <div class="col-md-4">
                      <h5 class="card-category">Y</h5>
                      <h2 class="card-title" id="targetY">--</h2>
                    </div>
                    <div class="col-md-4">
                      <h5 class="card-category">Z</h5>
                      <h2 class="card-title" id="targetZ">--</h2>
                    </div>
                  </div>
                  <button class="btn btn-primary btn-sm mt-3" onclick="moveToTarget()">
                    <i class="material-icons">navigation</i> Move to Target
                  </button>
                </div>
              </div>
            </div>

            <div class="col-lg-6 col-md-12">
              <div class="card">
                <div class="card-header card-header-success">
                  <h4 class="card-title">Current Position (Dobot)</h4>
                  <p class="card-category">Real-time robot position</p>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-3">
                      <h5 class="card-category">X</h5>
                      <h2 class="card-title" id="currentX">--</h2>
                    </div>
                    <div class="col-md-3">
                      <h5 class="card-category">Y</h5>
                      <h2 class="card-title" id="currentY">--</h2>
                    </div>
                    <div class="col-md-3">
                      <h5 class="card-category">Z</h5>
                      <h2 class="card-title" id="currentZ">--</h2>
                    </div>
                    <div class="col-md-3">
                      <h5 class="card-category">R</h5>
                      <h2 class="card-title" id="currentR">--</h2>
                    </div>
                  </div>
                  <button class="btn btn-success btn-sm mt-3" onclick="useCurrentPosition()">
                    <i class="material-icons">my_location</i> Use Current
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Control Cards -->
          <div class="row">
            <!-- PLC Control Bits -->
            <div class="col-lg-4 col-md-12">
              <div class="card">
                <div class="card-header card-header-primary">
                  <h4 class="card-title">PLC Control Bits</h4>
                  <p class="card-category">Status from DB1</p>
                </div>
                <div class="card-body table-responsive">
                  <table class="table">
                    <tbody>
                      <tr><td>Start</td><td id="bitStart" class="text-right">--</td></tr>
                      <tr><td>Stop</td><td id="bitStop" class="text-right">--</td></tr>
                      <tr><td>Home</td><td id="bitHome" class="text-right">--</td></tr>
                      <tr><td>E-Stop</td><td id="bitEstop" class="text-right">--</td></tr>
                      <tr><td>Suction</td><td id="bitSuction" class="text-right">--</td></tr>
                      <tr><td>Ready</td><td id="bitReady" class="text-right">--</td></tr>
                      <tr><td>Busy</td><td id="bitBusy" class="text-right">--</td></tr>
                      <tr><td>Error</td><td id="bitError" class="text-right">--</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Manual Control -->
            <div class="col-lg-4 col-md-12">
              <div class="card">
                <div class="card-header card-header-warning">
                  <h4 class="card-title">Manual Control</h4>
                  <p class="card-category">Direct position control</p>
                </div>
                <div class="card-body">
                  <div class="form-group">
                    <label>X Position</label>
                    <input type="number" id="manualX" class="form-control" placeholder="X" value="200">
                  </div>
                  <div class="form-group">
                    <label>Y Position</label>
                    <input type="number" id="manualY" class="form-control" placeholder="Y" value="0">
                  </div>
                  <div class="form-group">
                    <label>Z Position</label>
                    <input type="number" id="manualZ" class="form-control" placeholder="Z" value="200">
                  </div>
                  <div class="form-group">
                    <label>R Rotation</label>
                    <input type="number" id="manualR" class="form-control" placeholder="R" value="0">
                  </div>
                  <button class="btn btn-warning btn-block" onclick="moveToManual()">
                    <i class="material-icons">send</i> Move to Position
                  </button>
                </div>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="col-lg-4 col-md-12">
              <div class="card">
                <div class="card-header card-header-danger">
                  <h4 class="card-title">Quick Actions</h4>
                  <p class="card-category">Common operations</p>
                </div>
                <div class="card-body">
                  <button class="btn btn-info preset-btn" onclick="homeRobot()">
                    <i class="material-icons">home</i> Home Robot
                  </button>
                  <button class="btn btn-success preset-btn" onclick="moveToPreset('safe')">
                    <i class="material-icons">safety_check</i> Safe Position
                  </button>
                  <button class="btn btn-primary preset-btn" onclick="moveToPreset('pickup')">
                    <i class="material-icons">pan_tool</i> Pickup Position
                  </button>
                  <button class="btn btn-primary preset-btn" onclick="moveToPreset('dropoff')">
                    <i class="material-icons">place</i> Dropoff Position
                  </button>
                  <button class="btn btn-warning preset-btn" onclick="testRobot()">
                    <i class="material-icons">play_circle</i> Test Sequence
                  </button>
                  <button class="btn btn-danger preset-btn" onclick="emergencyStop()">
                    <i class="material-icons">stop_circle</i> Emergency Stop
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- End Effector & Debug -->
          <div class="row">
            <!-- End Effector Controls -->
            <div class="col-lg-6 col-md-12">
              <div class="card">
                <div class="card-header card-header-info">
                  <h4 class="card-title">End Effector Control</h4>
                  <p class="card-category">Suction & Gripper</p>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <h5>Suction Pump</h5>
                      <button class="btn btn-success btn-block mb-2" onclick="suctionOn()">
                        <i class="material-icons">power</i> Pump ON
                      </button>
                      <button class="btn btn-default btn-block" onclick="suctionOff()">
                        <i class="material-icons">power_off</i> Pump OFF
                      </button>
                    </div>
                    <div class="col-md-6">
                      <h5>Gripper</h5>
                      <button class="btn btn-success btn-block mb-2" onclick="gripperOpen()">
                        <i class="material-icons">open_in_full</i> Open
                      </button>
                      <button class="btn btn-default btn-block" onclick="gripperClose()">
                        <i class="material-icons">close_fullscreen</i> Close
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Settings & Debug -->
            <div class="col-lg-6 col-md-12">
              <div class="card">
                <div class="card-header card-header-warning">
                  <h4 class="card-title">System Management</h4>
                  <p class="card-category">Configuration & debugging</p>
                </div>
                <div class="card-body">
                  <button class="btn btn-primary btn-block mb-2" onclick="openSettings()">
                    <i class="material-icons">settings</i> System Settings
                  </button>
                  <button class="btn btn-info btn-block mb-2" onclick="debugDobot()">
                    <i class="material-icons">bug_report</i> Debug Dobot
                  </button>
                  <button class="btn btn-warning btn-block" onclick="clearLog()">
                    <i class="material-icons">clear_all</i> Clear Log
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Debug Log -->
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header card-header-success">
                  <h4 class="card-title">Debug Log</h4>
                  <p class="card-category">Real-time system messages</p>
                </div>
                <div class="card-body">
                  <div id="debugLog">
                    <div style="color: #94a3b8;">Waiting for commands...</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <footer class="footer">
        <div class="container-fluid">
          <div class="copyright float-right">
            &copy; <script>document.write(new Date().getFullYear())</script> Smart Factory Control System
          </div>
        </div>
      </footer>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="settings-modal">
    <div class="settings-content">
      <span class="settings-close" onclick="closeSettings()">&times;</span>
      <h2 style="color: #a8c7fa; margin-bottom: 24px;">System Settings</h2>
      
      <h3 style="color: #bcc7dc; margin-top: 24px;">Dobot Configuration</h3>
      <div style="margin-bottom: 18px;">
        <label style="display: block; font-weight: 600; margin-bottom: 8px;">USB Port:</label>
        <select id="settingDobotUSB" style="width: 100%; padding: 12px; background: #1c1b1f; border: 1px solid #44464f; color: #e4e1e6; border-radius: 4px;">
          <option value="">Loading...</option>
        </select>
        <small style="display: block; margin-top: 6px;">Select the USB port for Dobot connection</small>
      </div>
      
      <div style="margin-bottom: 18px;">
        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Home Position:</label>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
          <div>
            <input type="number" id="settingHomeX" style="width: 100%; padding: 12px; background: #1c1b1f; border: 1px solid #44464f; color: #e4e1e6; border-radius: 4px;" placeholder="X">
          </div>
          <div>
            <input type="number" id="settingHomeY" style="width: 100%; padding: 12px; background: #1c1b1f; border: 1px solid #44464f; color: #e4e1e6; border-radius: 4px;" placeholder="Y">
          </div>
          <div>
            <input type="number" id="settingHomeZ" style="width: 100%; padding: 12px; background: #1c1b1f; border: 1px solid #44464f; color: #e4e1e6; border-radius: 4px;" placeholder="Z">
          </div>
          <div>
            <input type="number" id="settingHomeR" style="width: 100%; padding: 12px; background: #1c1b1f; border: 1px solid #44464f; color: #e4e1e6; border-radius: 4px;" placeholder="R">
          </div>
        </div>
      </div>

      <h3 style="color: #bcc7dc; margin-top: 24px;">PLC Configuration</h3>
      <div style="margin-bottom: 18px;">
        <label style="display: block; font-weight: 600; margin-bottom: 8px;">PLC IP Address:</label>
        <input type="text" id="settingPLCIP" style="width: 100%; padding: 12px; background: #1c1b1f; border: 1px solid #44464f; color: #e4e1e6; border-radius: 4px;" placeholder="192.168.0.1">
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 18px;">
        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 8px;">Rack:</label>
          <input type="number" id="settingPLCRack" style="width: 100%; padding: 12px; background: #1c1b1f; border: 1px solid #44464f; color: #e4e1e6; border-radius: 4px;" placeholder="0">
        </div>
        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 8px;">Slot:</label>
          <input type="number" id="settingPLCSlot" style="width: 100%; padding: 12px; background: #1c1b1f; border: 1px solid #44464f; color: #e4e1e6; border-radius: 4px;" placeholder="1">
        </div>
      </div>
      <div style="margin-bottom: 18px;">
        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Poll Interval (seconds):</label>
        <input type="number" step="0.1" id="settingPollInterval" style="width: 100%; padding: 12px; background: #1c1b1f; border: 1px solid #44464f; color: #e4e1e6; border-radius: 4px;" placeholder="2.0">
        <small style="display: block; margin-top: 6px;">How often to read PLC data (2.0 recommended for S7-1200)</small>
      </div>

      <div style="display: flex; gap: 12px; margin-top: 30px;">
        <button class="btn btn-success" onclick="saveSettings()" style="flex: 1;">Save Settings</button>
        <button class="btn btn-primary" onclick="restartServer()" style="flex: 1;">Restart Server</button>
        <button class="btn btn-danger" onclick="closeSettings()" style="flex: 1;">Cancel</button>
      </div>
      
      <div style="margin-top: 24px; padding: 18px; background: rgba(245, 158, 11, 0.15); border: 1px solid #ffb870; color: #ffb870; border-radius: 4px;">
        ‚ö†Ô∏è Note: Server restart required for changes to take effect. Click "Save Settings" then restart the app.
      </div>
    </div>
  </div>

  <!-- Core JS Files -->
  <script src="./assets/js/core/jquery.min.js"></script>
  <script src="./assets/js/core/popper.min.js"></script>
  <script src="./assets/js/core/bootstrap-material-design.min.js"></script>
  <script src="./assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>
  <script src="./assets/js/plugins/bootstrap-notify.js"></script>
  <script src="./assets/js/material-dashboard.js?v=2.1.0"></script>

  <script>
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').then(reg => {
        console.log('Service Worker registered:', reg);
      }).catch(err => {
        console.error('Service Worker registration failed:', err);
      });
    }

    // Polling interval
    let pollInterval = null;
    let isPolling = false;

    function updatePLCStatus(connected) {
      const dot = document.getElementById('plcDot');
      const text = document.getElementById('plcStatus');

      if (connected) {
        dot.classList.add('connected');
        text.textContent = 'Connected';
        text.style.color = '#10b981';
      } else {
        dot.classList.remove('connected');
        text.textContent = 'Disconnected';
        text.style.color = '#ef4444';
      }
    }

    function updateDobotStatus(connected) {
      const dot = document.getElementById('dobotDot');
      const text = document.getElementById('dobotStatus');

      if (connected) {
        dot.classList.add('connected');
        text.textContent = 'Connected';
        text.style.color = '#10b981';
      } else {
        dot.classList.remove('connected');
        text.textContent = 'Disconnected';
        text.style.color = '#ef4444';
      }
    }

    async function fetchAllData() {
      try {
        const response = await fetch('/api/data');
        const data = await response.json();

        updatePLCStatus(data.plc.status.connected);

        document.getElementById('targetX').textContent = data.plc.pose.x?.toFixed(2) || '--';
        document.getElementById('targetY').textContent = data.plc.pose.y?.toFixed(2) || '--';
        document.getElementById('targetZ').textContent = data.plc.pose.z?.toFixed(2) || '--';

        const bits = data.plc.control;
        document.getElementById('bitStart').textContent = bits.start ? 'ON' : 'OFF';
        document.getElementById('bitStart').style.color = bits.start ? '#10b981' : '#ef4444';
        document.getElementById('bitStop').textContent = bits.stop ? 'ON' : 'OFF';
        document.getElementById('bitStop').style.color = bits.stop ? '#10b981' : '#ef4444';
        document.getElementById('bitHome').textContent = bits.home ? 'ON' : 'OFF';
        document.getElementById('bitHome').style.color = bits.home ? '#10b981' : '#ef4444';
        document.getElementById('bitEstop').textContent = bits.estop ? 'ON' : 'OFF';
        document.getElementById('bitEstop').style.color = bits.estop ? '#ef4444' : '#10b981';
        document.getElementById('bitSuction').textContent = bits.suction ? 'ON' : 'OFF';
        document.getElementById('bitSuction').style.color = bits.suction ? '#10b981' : '#ef4444';
        document.getElementById('bitReady').textContent = bits.ready ? 'ON' : 'OFF';
        document.getElementById('bitReady').style.color = bits.ready ? '#10b981' : '#ef4444';
        document.getElementById('bitBusy').textContent = bits.busy ? 'ON' : 'OFF';
        document.getElementById('bitBusy').style.color = bits.busy ? '#f59e0b' : '#10b981';
        document.getElementById('bitError').textContent = bits.error ? 'ON' : 'OFF';
        document.getElementById('bitError').style.color = bits.error ? '#ef4444' : '#10b981';

        updateDobotStatus(data.dobot.status.connected);

        if (data.dobot.status.connected) {
          document.getElementById('currentX').textContent = data.dobot.pose.x?.toFixed(2) || '--';
          document.getElementById('currentY').textContent = data.dobot.pose.y?.toFixed(2) || '--';
          document.getElementById('currentZ').textContent = data.dobot.pose.z?.toFixed(2) || '--';
          document.getElementById('currentR').textContent = data.dobot.pose.r?.toFixed(2) || '--';
        } else {
          document.getElementById('currentX').textContent = '--';
          document.getElementById('currentY').textContent = '--';
          document.getElementById('currentZ').textContent = '--';
          document.getElementById('currentR').textContent = '--';
        }

        const now = new Date();
        document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();

      } catch (error) {
        console.error('Error fetching data:', error);
        updatePLCStatus(false);
        updateDobotStatus(false);
      }
    }

    async function pollData() {
      if (isPolling) return;
      isPolling = true;
      try {
        await fetchAllData();
      } finally {
        isPolling = false;
      }
    }

    function startPolling() {
      if (pollInterval) return;
      pollData();
      pollInterval = setInterval(pollData, 2000);
    }

    function stopPolling() {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
    }

    function addLog(message, type = 'info') {
      const logDiv = document.getElementById('debugLog');
      const timestamp = new Date().toLocaleTimeString();
      const colors = {
        'info': '#0ea5e9',
        'success': '#10b981',
        'error': '#ef4444',
        'warning': '#f59e0b'
      };
      const color = colors[type] || colors['info'];
      
      const entry = document.createElement('div');
      entry.style.color = color;
      entry.style.marginBottom = '6px';
      entry.innerHTML = `[${timestamp}] ${message}`;
      
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      
      while (logDiv.children.length > 50) {
        logDiv.removeChild(logDiv.firstChild);
      }
    }

    function clearLog() {
      document.getElementById('debugLog').innerHTML = '<div style="color: #94a3b8;">Log cleared...</div>';
    }

    async function homeRobot() {
      try {
        addLog('üè† Sending home command...', 'info');
        const response = await fetch('/api/dobot/home', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
          addLog('‚úÖ Home command sent!', 'success');
        } else {
          addLog('‚ùå Home failed: ' + (data.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        addLog('‚ùå Error: ' + error.message, 'error');
      }
    }

    async function moveToTarget() {
      const x = parseFloat(document.getElementById('targetX').textContent);
      const y = parseFloat(document.getElementById('targetY').textContent);
      const z = parseFloat(document.getElementById('targetZ').textContent);

      if (isNaN(x) || isNaN(y) || isNaN(z)) {
        addLog('‚ùå Invalid target position values', 'error');
        return;
      }

      try {
        addLog(`‚û°Ô∏è Moving to (${x}, ${y}, ${z})...`, 'info');
        const response = await fetch('/api/dobot/move', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ x, y, z, r: 0 })
        });
        const data = await response.json();
        if (data.success) {
          addLog('‚úÖ Move command executed successfully!', 'success');
        } else {
          addLog('‚ùå Move failed: ' + (data.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        addLog('‚ùå Error: ' + error.message, 'error');
      }
    }

    async function moveToManual() {
      const x = parseFloat(document.getElementById('manualX').value);
      const y = parseFloat(document.getElementById('manualY').value);
      const z = parseFloat(document.getElementById('manualZ').value);
      const r = parseFloat(document.getElementById('manualR').value) || 0;

      if (isNaN(x) || isNaN(y) || isNaN(z)) {
        addLog('‚ùå Please enter valid X, Y, Z coordinates', 'error');
        return;
      }

      if (Math.abs(x) > 500 || Math.abs(y) > 500 || z < 0 || z > 500) {
        addLog(`‚ö†Ô∏è Warning: Position (${x}, ${y}, ${z}) may be outside safe range.`, 'warning');
      }

      try {
        addLog(`‚û°Ô∏è Moving to manual position (${x}, ${y}, ${z}, ${r})...`, 'info');
        const response = await fetch('/api/dobot/move', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ x, y, z, r })
        });
        const data = await response.json();
        if (data.success) {
          addLog('‚úÖ Robot moved successfully!', 'success');
        } else {
          addLog('‚ùå Move failed: ' + (data.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        addLog('‚ùå Error: ' + error.message, 'error');
      }
    }

    function useCurrentPosition() {
      const x = document.getElementById('currentX').textContent;
      const y = document.getElementById('currentY').textContent;
      const z = document.getElementById('currentZ').textContent;
      const r = document.getElementById('currentR').textContent;

      if (x === '--' || y === '--' || z === '--') {
        addLog('‚ùå No current position available. Connect to Dobot first.', 'error');
        return;
      }

      document.getElementById('manualX').value = parseFloat(x);
      document.getElementById('manualY').value = parseFloat(y);
      document.getElementById('manualZ').value = parseFloat(z);
      document.getElementById('manualR').value = parseFloat(r);

      addLog('‚úÖ Current position loaded into manual controls', 'success');
    }

    async function suctionOn() {
      try {
        addLog('üîå Turning pump ON...', 'info');
        const response = await fetch('/api/dobot/suction', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enable: true })
        });
        const data = await response.json();
        if (data.success) {
          addLog('‚úÖ Pump activated', 'success');
        } else {
          addLog('‚ùå Failed to activate pump', 'error');
        }
      } catch (error) {
        addLog('‚ùå Error: ' + error.message, 'error');
      }
    }

    async function suctionOff() {
      try {
        addLog('üîå Turning pump OFF...', 'info');
        const response = await fetch('/api/dobot/suction', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enable: false })
        });
        const data = await response.json();
        if (data.success) {
          addLog('‚úÖ Pump deactivated', 'success');
        } else {
          addLog('‚ùå Failed to deactivate pump', 'error');
        }
      } catch (error) {
        addLog('‚ùå Error: ' + error.message, 'error');
      }
    }

    async function gripperOpen() {
      try {
        addLog('ü§è Opening gripper...', 'info');
        const response = await fetch('/api/dobot/gripper', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ open: true })
        });
        const data = await response.json();
        if (data.success) {
          addLog('‚úÖ Gripper opened', 'success');
        } else {
          addLog('‚ÑπÔ∏è ' + (data.message || 'Gripper not available'), 'warning');
        }
      } catch (error) {
        addLog('‚ùå Error: ' + error.message, 'error');
      }
    }

    async function gripperClose() {
      try {
        addLog('ü§è Closing gripper...', 'info');
        const response = await fetch('/api/dobot/gripper', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ open: false })
        });
        const data = await response.json();
        if (data.success) {
          addLog('‚úÖ Gripper closed', 'success');
        } else {
          addLog('‚ÑπÔ∏è ' + (data.message || 'Gripper not available'), 'warning');
        }
      } catch (error) {
        addLog('‚ùå Error: ' + error.message, 'error');
      }
    }

    async function moveToPreset(preset) {
      const presets = {
        safe: { x: 200, y: 0, z: 200, r: 0, name: 'Safe Position' },
        pickup: { x: 250, y: 50, z: 50, r: 0, name: 'Pickup Position' },
        dropoff: { x: 250, y: -50, z: 50, r: 0, name: 'Dropoff Position' },
        inspect: { x: 200, y: 0, z: 100, r: 0, name: 'Inspect Position' }
      };

      const pos = presets[preset];
      if (!pos) return;

      try {
        addLog(`üìç Moving to ${pos.name}...`, 'info');
        const response = await fetch('/api/dobot/move', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ x: pos.x, y: pos.y, z: pos.z, r: pos.r })
        });
        const data = await response.json();
        if (data.success) {
          addLog(`‚úÖ Moved to ${pos.name}`, 'success');
        } else {
          addLog('‚ùå Move failed', 'error');
        }
      } catch (error) {
        addLog('‚ùå Error: ' + error.message, 'error');
      }
    }

    async function testRobot() {
      addLog('üß™ Starting robot test sequence...', 'info');

      try {
        const response = await fetch('/api/dobot/test', { method: 'POST' });
        const data = await response.json();

        if (data.steps) {
          data.steps.forEach(step => {
            const emoji = step.success ? '‚úÖ' : '‚ùå';
            const type = step.success ? 'success' : 'error';
            addLog(`${emoji} Step ${step.step}: ${step.name} - ${step.message}`, type);
          });
        }

        if (data.success) {
          addLog('‚úÖ All tests passed! Robot is working perfectly!', 'success');
        } else {
          addLog('‚ö†Ô∏è Some tests failed. Check details above.', 'warning');
        }
      } catch (error) {
        addLog('‚ùå Test error: ' + error.message, 'error');
      }
    }

    async function emergencyStop() {
      try {
        addLog('üõë EMERGENCY STOP TRIGGERED!', 'error');
        const response = await fetch('/api/emergency-stop', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
          addLog('‚ö†Ô∏è EMERGENCY STOP activated! All movement stopped.', 'warning');
        }
      } catch (error) {
        addLog('‚ùå Error: ' + error.message, 'error');
      }
    }

    async function openSettings() {
      try {
        addLog('‚öôÔ∏è Loading settings...', 'info');
        
        const response = await fetch('/api/settings');
        const settings = await response.json();
        
        const usbSelect = document.getElementById('settingDobotUSB');
        usbSelect.innerHTML = '<option value="">Auto-detect (recommended)</option>';
        
        if (settings.available_usb_ports && settings.available_usb_ports.length > 0) {
          addLog(`‚úÖ Found ${settings.available_usb_ports.length} USB devices`, 'success');
          settings.available_usb_ports.forEach(port => {
            const option = document.createElement('option');
            option.value = port;
            option.textContent = port;
            usbSelect.appendChild(option);
          });
        } else {
          addLog('‚ö†Ô∏è No USB devices detected', 'warning');
          const option = document.createElement('option');
          option.value = '/dev/ttyACM0';
          option.textContent = '/dev/ttyACM0 (fallback)';
          usbSelect.appendChild(option);
        }
        
        usbSelect.value = settings.dobot.usb_path || '';
        document.getElementById('settingHomeX').value = settings.dobot.home_position.x;
        document.getElementById('settingHomeY').value = settings.dobot.home_position.y;
        document.getElementById('settingHomeZ').value = settings.dobot.home_position.z;
        document.getElementById('settingHomeR').value = settings.dobot.home_position.r;
        document.getElementById('settingPLCIP').value = settings.plc.ip;
        document.getElementById('settingPLCRack').value = settings.plc.rack;
        document.getElementById('settingPLCSlot').value = settings.plc.slot;
        document.getElementById('settingPollInterval').value = settings.plc.poll_interval;
        
        document.getElementById('settingsModal').style.display = 'block';
      } catch (error) {
        addLog('‚ùå Error loading settings: ' + error.message, 'error');
        alert('Error loading settings: ' + error.message);
      }
    }

    function closeSettings() {
      document.getElementById('settingsModal').style.display = 'none';
    }

    async function saveSettings() {
      try {
        const settings = {
          dobot: {
            usb_path: document.getElementById('settingDobotUSB').value || '/dev/ttyACM0',
            home_position: {
              x: parseFloat(document.getElementById('settingHomeX').value),
              y: parseFloat(document.getElementById('settingHomeY').value),
              z: parseFloat(document.getElementById('settingHomeZ').value),
              r: parseFloat(document.getElementById('settingHomeR').value)
            },
            use_usb: true
          },
          plc: {
            ip: document.getElementById('settingPLCIP').value,
            rack: parseInt(document.getElementById('settingPLCRack').value),
            slot: parseInt(document.getElementById('settingPLCSlot').value),
            db_number: 1,
            poll_interval: parseFloat(document.getElementById('settingPollInterval').value)
          }
        };

        addLog('üíæ Saving settings...', 'info');
        const response = await fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });

        const result = await response.json();
        if (result.success) {
          addLog('‚úÖ Settings saved! Restart server to apply.', 'success');
          alert('Settings saved successfully!\n\nRestart the server for changes to take effect.');
          closeSettings();
        } else {
          addLog('‚ùå Failed to save settings', 'error');
          alert('Failed to save settings: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        addLog('‚ùå Error: ' + error.message, 'error');
        alert('Error saving settings: ' + error.message);
      }
    }

    async function restartServer() {
      if (!confirm('Are you sure you want to restart the server?')) {
        return;
      }

      try {
        addLog('üîÑ Restarting server...', 'info');
        const response = await fetch('/api/restart', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
          addLog('‚úÖ ' + result.message, 'success');
          alert('‚úÖ ' + result.message + '\n\nThe page will reload automatically.');
          closeSettings();
          setTimeout(() => {
            window.location.reload();
          }, 3000);
        } else {
          addLog('‚ùå Restart failed: ' + (result.error || 'Unknown error'), 'error');
          alert('Restart failed: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        addLog('‚ùå Error: ' + error.message, 'error');
        alert('Error restarting server: ' + error.message);
      }
    }

    async function debugDobot() {
      try {
        addLog('üêõ Getting Dobot debug information...', 'info');
        const response = await fetch('/api/dobot/debug');
        const debug = await response.json();
        
        addLog('üìã Dobot Debug Information:', 'info');
        addLog(`  pydobot available: ${debug.pydobot_available}`, debug.pydobot_available ? 'success' : 'error');
        addLog(`  USB enabled: ${debug.use_usb}`, debug.use_usb ? 'success' : 'warning');
        addLog(`  Configured port: ${debug.configured_port}`, 'info');
        addLog(`  Actual port: ${debug.actual_port || 'None'}`, debug.actual_port ? 'success' : 'warning');
        addLog(`  Connected: ${debug.connected}`, debug.connected ? 'success' : 'error');
        addLog(`  Last error: ${debug.last_error || 'None'}`, debug.last_error ? 'error' : 'success');
        
        addLog(`  Available ports: ${debug.available_ports.length} found`, debug.available_ports.length > 0 ? 'success' : 'error');
        debug.available_ports.forEach(port => {
          addLog(`    - ${port}`, 'info');
        });
        
        debug.port_details.forEach(port => {
          if (port.exists) {
            addLog(`  Port ${port.port}: permissions=${port.permissions}, readable=${port.readable}, writable=${port.writable}`, 
              (port.readable && port.writable) ? 'success' : 'warning');
          } else {
            addLog(`  Port ${port.port}: ${port.error}`, 'error');
          }
        });
        
        if (!debug.pydobot_available) {
          addLog('üí° To fix: pip install pydobot', 'info');
        }
        if (!debug.connected && debug.available_ports.length === 0) {
          addLog('üí° Check if Dobot is connected via USB', 'info');
        }
        if (!debug.connected && debug.available_ports.length > 0) {
          addLog('üí° Try: sudo chmod 666 /dev/ttyACM*', 'info');
        }
        
      } catch (error) {
        addLog('‚ùå Debug error: ' + error.message, 'error');
      }
    }

    window.addEventListener('load', startPolling);
    window.addEventListener('beforeunload', stopPolling);
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        stopPolling();
      } else {
        startPolling();
      }
    });
  </script>
</body>
</html>
