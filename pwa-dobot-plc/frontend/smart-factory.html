<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <link rel="apple-touch-icon" sizes="76x76" href="./assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="./assets/img/favicon.png">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>Smart Factory - Control System</title>
  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
  
  <!-- Fonts and icons -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
  
  <!-- CSS Files -->
  <link href="./assets/css/material-dashboard.min.css?v=2.1.0" rel="stylesheet" />
  <link href="./assets/css/professional-theme.css" rel="stylesheet" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#030c1d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- All styles consolidated in professional-theme.css -->
</head>

<body class="dark-edition">
  <div class="wrapper">
    <div class="sidebar" data-color="purple" data-background-color="black" data-image="">
      <div class="sidebar-animated-bg" id="sidebarAnimatedBg"></div>
      <div class="logo">
        <a href="/" class="simple-text logo-normal">
          <i class="material-icons">factory</i>
          Smart Factory
        </a>
      </div>
      <div class="sidebar-wrapper">
        <ul class="nav">
          <li class="nav-item">
            <a class="nav-link" href="/index.html">
              <i class="material-icons">dashboard</i>
              <p>Dashboard</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/robot-arm.html">
              <i class="material-icons">precision_manufacturing</i>
              <p>Robot Arm</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/vision-system.html">
              <i class="material-icons">visibility</i>
              <p>Vision System</p>
            </a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="/smart-factory.html">
              <i class="material-icons">settings</i>
              <p>Factory Control</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/rfid.html">
              <i class="material-icons">nfc</i>
              <p>RFID Tracking</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/digital-twin.html">
              <i class="material-icons">view_in_ar</i>
              <p>Digital Twin</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/plc-diagnostics.html">
              <i class="material-icons">analytics</i>
              <p>PLC Diagnostics</p>
            </a>
          </li>
        </ul>
      </div>
    </div>

    <div class="main-panel">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-transparent navbar-absolute fixed-top">
        <div class="container-fluid">
          <div class="navbar-wrapper">
            <a class="navbar-brand" href="javascript:;">Smart Factory Control</a>
          </div>
          <button class="navbar-toggler" type="button" data-toggle="collapse" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="navbar-toggler-icon icon-bar"></span>
            <span class="navbar-toggler-icon icon-bar"></span>
            <span class="navbar-toggler-icon icon-bar"></span>
          </button>
        </div>
      </nav>
      <!-- End Navbar -->

      <div class="content">
        <div class="container-fluid">
          <div class="row">
            <!-- Production Counter -->
            <div class="col-lg-3 col-md-6 col-sm-6">
              <div class="card card-stats kpi-card">
                <div class="card-header card-header-info card-header-icon">
                  <div class="card-icon">
                    <i class="material-icons">inventory</i>
                  </div>
                  <p class="card-category">Production Counter</p>
                  <h3 class="card-title kpi-value" id="production-counter">0</h3>
                </div>
                <div class="card-footer">
                  <div class="stats">
                    <span class="kpi-status status-normal">Items Processed</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Conveyor Status -->
            <div class="col-lg-3 col-md-6 col-sm-6">
              <div class="card card-stats kpi-card">
                <div class="card-header card-header-success card-header-icon">
                  <div class="card-icon">
                    <i class="material-icons">conveyor_belt</i>
                  </div>
                  <p class="card-category">Conveyor System</p>
                  <h3 class="card-title" id="conveyor-status">UNKNOWN</h3>
                </div>
                <div class="card-footer">
                  <div class="stats">
                    <span class="kpi-status" id="conveyor-status-badge">Unknown</span>
                    <div><small id="conveyor-subtitle">Status: Checking...</small></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Gantry Status -->
            <div class="col-lg-3 col-md-6 col-sm-6">
              <div class="card card-stats kpi-card">
                <div class="card-header card-header-warning card-header-icon">
                  <div class="card-icon">
                    <i class="material-icons">precision_manufacturing</i>
                  </div>
                  <p class="card-category">Gantry Robot</p>
                  <h3 class="card-title" id="gantry-status">UNKNOWN</h3>
                </div>
                <div class="card-footer">
                  <div class="stats">
                    <span class="kpi-status" id="gantry-status-badge">Unknown</span>
                    <div><small id="gantry-subtitle">Status: Checking...</small></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- System Uptime -->
            <div class="col-lg-3 col-md-6 col-sm-6">
              <div class="card card-stats kpi-card">
                <div class="card-header card-header-primary card-header-icon">
                  <div class="card-icon">
                    <i class="material-icons">schedule</i>
                  </div>
                  <p class="card-category">System Uptime</p>
                  <h3 class="card-title kpi-value" id="uptime">0%</h3>
                </div>
                <div class="card-footer">
                  <div class="stats">
                    <span class="kpi-status status-normal" id="uptime-duration">0h 0m</span>
                    <div class="progress-bar">
                      <div class="progress-fill" id="uptime-bar" style="width: 0%"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <!-- Faults Detected -->
            <div class="col-lg-3 col-md-6 col-sm-6">
              <div class="card card-stats kpi-card">
                <div class="card-header card-header-danger card-header-icon">
                  <div class="card-icon">
                    <i class="material-icons">error_outline</i>
                  </div>
                  <p class="card-category">Faults Detected</p>
                  <h3 class="card-title kpi-value" id="total-faults">0</h3>
                </div>
                <div class="card-footer">
                  <div class="stats">
                    <span class="kpi-status status-warning">Since Start</span>
                    <div><small id="fault-subtitle">Monitoring...</small></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Active Faults -->
            <div class="col-lg-3 col-md-6 col-sm-6">
              <div class="card card-stats kpi-card">
                <div class="card-header card-header-rose card-header-icon">
                  <div class="card-icon">
                    <i class="material-icons">warning</i>
                  </div>
                  <p class="card-category">Active Faults</p>
                  <h3 class="card-title kpi-value" id="active-faults">0</h3>
                </div>
                <div class="card-footer">
                  <div class="stats">
                    <span class="kpi-status" id="active-faults-badge">None</span>
                    <div class="fault-list" id="fault-list">
                      <div class="no-faults">No active faults</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Efficiency Rate -->
            <div class="col-lg-3 col-md-6 col-sm-6">
              <div class="card card-stats kpi-card">
                <div class="card-header card-header-success card-header-icon">
                  <div class="card-icon">
                    <i class="material-icons">speed</i>
                  </div>
                  <p class="card-category">Efficiency Rate</p>
                  <h3 class="card-title kpi-value" id="efficiency">0%</h3>
                </div>
                <div class="card-footer">
                  <div class="stats">
                    <span class="kpi-status status-normal">Target: 95%</span>
                    <div class="progress-bar">
                      <div class="progress-fill" id="efficiency-bar" style="width: 0%"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Quality Control -->
            <div class="col-lg-3 col-md-6 col-sm-6">
              <div class="card card-stats kpi-card">
                <div class="card-header card-header-info card-header-icon">
                  <div class="card-icon">
                    <i class="material-icons">verified</i>
                  </div>
                  <p class="card-category">Quality Control</p>
                  <h3 class="card-title kpi-value" id="quality">0%</h3>
                </div>
                <div class="card-footer">
                  <div class="stats">
                    <span class="kpi-status status-normal">Pass Rate</span>
                    <div><small id="quality-subtitle">Defects: 0 items</small></div>
                    <div class="progress-bar">
                      <div class="progress-fill" id="quality-bar" style="width: 0%"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Core JS Files -->
  <script src="./assets/js/core/jquery.min.js"></script>
  <script src="./assets/js/core/popper.min.js"></script>
  <script src="./assets/js/core/bootstrap-material-design.min.js"></script>
  <script src="./assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>
  <script src="./assets/js/material-dashboard.min.js?v=2.1.0" type="text/javascript"></script>

  <script>
    // Real-time dashboard updates from backend API
    function updateKPIs() {
      // Fetch real data from backend
      fetch('/api/smart-factory')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Update production counter
            const productionCounter = data.production_counter || 0;
            document.getElementById('production-counter').textContent = productionCounter.toLocaleString();
            
            // Update conveyor status
            const conveyorStatus = data.conveyor.status || 'UNKNOWN';
            const conveyorRunning = data.conveyor.running || false;
            document.getElementById('conveyor-status').textContent = conveyorStatus;
            const conveyorBadge = document.getElementById('conveyor-status-badge');
            conveyorBadge.textContent = conveyorRunning ? 'Active' : 'Inactive';
            conveyorBadge.className = 'kpi-status ' + (conveyorRunning ? 'status-running' : 'status-stopped');
            document.getElementById('conveyor-subtitle').textContent = 
              conveyorRunning ? 'System Active' : 'System Stopped';
            
            // Update gantry status
            const gantryStatus = data.gantry.status || 'UNKNOWN';
            const gantryRunning = data.gantry.running || false;
            const gantryConnected = data.gantry.connected || false;
            document.getElementById('gantry-status').textContent = gantryStatus;
            const gantryBadge = document.getElementById('gantry-status-badge');
            if (gantryRunning) {
              gantryBadge.textContent = 'Active';
              gantryBadge.className = 'kpi-status status-running';
            } else if (gantryConnected) {
              gantryBadge.textContent = 'Connected';
              gantryBadge.className = 'kpi-status status-normal';
            } else {
              gantryBadge.textContent = 'Disconnected';
              gantryBadge.className = 'kpi-status status-stopped';
            }
            document.getElementById('gantry-subtitle').textContent = 
              gantryRunning ? 'Cycle Active' : (gantryConnected ? 'Standby' : 'Not Connected');
            
            // Update uptime
            const uptimePercent = data.uptime.percent || 0;
            const uptimeDuration = data.uptime.duration || '0h 0m';
            document.getElementById('uptime').textContent = uptimePercent.toFixed(1) + '%';
            document.getElementById('uptime-duration').textContent = uptimeDuration;
            document.getElementById('uptime-bar').style.width = uptimePercent.toFixed(1) + '%';
            
            // Update faults
            const activeFaults = data.faults.active || 0;
            const totalFaults = data.faults.detected || 0;
            const faultDetected = data.faults.fault_detected || false;
            document.getElementById('total-faults').textContent = totalFaults;
            document.getElementById('active-faults').textContent = activeFaults;
            
            const activeFaultsBadge = document.getElementById('active-faults-badge');
            const faultList = document.getElementById('fault-list');
            
            if (activeFaults > 0 || faultDetected) {
              activeFaultsBadge.textContent = 'Critical';
              activeFaultsBadge.className = 'kpi-status status-stopped';
              faultList.innerHTML = '<div class="fault-item"><div class="fault-indicator"></div><div class="fault-text">Defect detected in production</div></div>';
            } else {
              activeFaultsBadge.textContent = 'None';
              activeFaultsBadge.className = 'kpi-status status-normal';
              faultList.innerHTML = '<div class="no-faults">No active faults</div>';
            }
            
            document.getElementById('fault-subtitle').textContent = 
              totalFaults > 0 ? `Total defects: ${totalFaults}` : 'No defects detected';
            
            // Update efficiency
            const efficiency = data.efficiency || 0;
            document.getElementById('efficiency').textContent = efficiency.toFixed(1) + '%';
            document.getElementById('efficiency-bar').style.width = efficiency.toFixed(1) + '%';
            
            // Update quality
            const quality = data.quality || 0;
            const defectCount = data.faults.detected || 0;
            document.getElementById('quality').textContent = quality.toFixed(1) + '%';
            document.getElementById('quality-bar').style.width = quality.toFixed(1) + '%';
            document.getElementById('quality-subtitle').textContent = `Defects: ${defectCount} items`;
          } else {
            console.error('Failed to fetch smart factory data:', data.error);
            // Show error state
            document.getElementById('production-counter').textContent = 'Error';
            document.getElementById('conveyor-status').textContent = 'ERROR';
            document.getElementById('gantry-status').textContent = 'ERROR';
          }
        })
        .catch(error => {
          console.error('Error fetching smart factory data:', error);
          // Show error state
          document.getElementById('production-counter').textContent = 'Error';
          document.getElementById('conveyor-status').textContent = 'ERROR';
          document.getElementById('gantry-status').textContent = 'ERROR';
        });
    }
    
    // Update immediately on page load
    updateKPIs();

    // Update every 2 seconds for real-time updates
    setInterval(updateKPIs, 2000);
  </script>

  <script>
    // Animated Factory Sidebar Background
    function initSidebarAnimation() {
      const container = document.getElementById('sidebarAnimatedBg');
      if (!container) return;

      for (let i = 0; i < 15; i++) {
        const particle = document.createElement('div');
        particle.className = 'factory-particle';
        particle.style.width = Math.random() * 4 + 2 + 'px';
        particle.style.height = particle.style.width;
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDuration = Math.random() * 10 + 8 + 's';
        particle.style.animationDelay = Math.random() * 5 + 's';
        container.appendChild(particle);
      }

      for (let i = 0; i < 8; i++) {
        const line = document.createElement('div');
        line.className = 'circuit-line';
        line.style.top = Math.random() * 100 + '%';
        line.style.width = Math.random() * 150 + 100 + 'px';
        line.style.animationDuration = Math.random() * 6 + 4 + 's';
        line.style.animationDelay = Math.random() * 3 + 's';
        container.appendChild(line);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSidebarAnimation);
    } else {
      initSidebarAnimation();
    }
  </script>
</body>
</html>
